# 通达信版面方案

基于策略执行手册的四层监控清单，在通达信中搭建初级版本，验证需求后再决定 TradePilot 的实现优先级。

---

## 一、自定义版面布局

通达信 → 功能 → 定制版面 → 新建版面

```
┌──────────────────────────────────────────────────────────┐
│ A区: 上证指数 周线K线 + MACD                              │
│     (切换: 深证/创业板/科创50)                              │
├────────────────────────┬─────────────────────────────────┤
│ B区: 板块指数列表       │ C区: 自选股列表                   │
│ 按60日涨幅排序          │ 自定义列:                         │
│ 列: 板块|1日%|5日%|60日% │ 代码|名称|现价|涨幅%|PB分位       │
│    |PB|状态(高位/低位)   │ |值博率|周MACD|所属板块|盈亏%      │
├────────────────────────┴─────────────────────────────────┤
│ D区: 选中个股 日线K线 + MACD + 成交量                       │
└──────────────────────────────────────────────────────────┘
```

### 设置步骤

1. 功能 → 定制版面 → 新建空白版面
2. 右键插入4个区块（上1、左下1、右下1、底1）
3. A区: 设为"分析图" → 默认显示上证指数周线
4. B区: 设为"报价列表" → 加入板块指数 → 右键添加自定义列
5. C区: 设为"报价列表" → 加入自选股 → 右键添加自定义列
6. D区: 设为"分析图" → 联动C区选中个股

---

## 二、自定义指标公式

通达信 → 功能 → 公式管理器 → 新建

### 2.1 值博率（副图/选股）

用于自选股列表的自定义列。

```tdx
{值博率 - 上涨空间/下跌风险}
{适用周期: 日线}

支撑:=LLV(L,20);
阻力:=HHV(H,60);
下跌空间:=C-支撑;
上涨空间:=阻力-C;

值博率:IF(下跌空间>0, 上涨空间/下跌空间, 99), NODRAW;

{使用方法: 自选股列表 → 右键 → 扩展数据 → 选择本公式}
{值博率 ≥ 3 为建仓候选}
```

### 2.2 PB历史分位数

```tdx
{PB历史分位 - 近250日PB所处位置}
{需要通达信专业版，支持财务数据函数}

当前PB:=CLOSE/FINANCE(34)*FINANCE(1)/10000;
PB分位:=COUNT(当前PB>CLOSE/FINANCE(34)*FINANCE(1)/10000, 250)/250*100;

{输出: 0-100, 越低越便宜}
{< 30 低估, > 70 高估}
```

> 注: 通达信免费版财务函数有限，如不可用可跳过此公式，直接在F10中查看PB。

### 2.3 周线MACD状态（用于自定义列）

```tdx
{周线MACD状态 - 在日线图上显示周线MACD方向}

周DIF:="MACD.DIF#WEEK";
周DEA:="MACD.DEA#WEEK";
周MACD柱:=(周DIF-周DEA)*2;

状态:IF(周DIF>周DEA AND 周MACD柱>REF(周MACD柱,1), 1,
     IF(周DIF>周DEA AND 周MACD柱<=REF(周MACD柱,1), 2,
     IF(周DIF<周DEA AND 周MACD柱<REF(周MACD柱,1), -1,
     IF(周DIF<周DEA AND 周MACD柱>=REF(周MACD柱,1), -2, 0)))), NODRAW;

{输出含义:}
{ 1 = 金叉+柱放大 (强势)}
{ 2 = 金叉+柱缩小 (转弱)}
{-1 = 死叉+柱放大 (弱势)}
{-2 = 死叉+柱缩小 (企稳)}
```

### 2.4 建仓信号综合（副图指标）

```tdx
{建仓信号综合 - 叠加在个股日线图下方}

{--- 技术面 ---}
DIF:=EMA(C,12)-EMA(C,26);
DEA:=EMA(DIF,9);
MACD柱:=(DIF-DEA)*2;

日线金叉:=CROSS(DIF,DEA);
日线死叉:=CROSS(DEA,DIF);

{放量突破: 量>5日均量2倍 且 收阳}
MA5量:=MA(V,5);
放量突破:=V>MA5量*2 AND C>O;

{高位缩量: 量<5日均量一半 且 近20日高位}
高位缩量:=V<MA5量*0.5 AND C>LLV(L,20)*1.1;

{地量: 量为60日最低}
地量:=V<=LLV(V,60);

{--- 估值面 ---}
支撑:=LLV(L,20);
阻力:=HHV(H,60);
值博率OK:=IF((C-支撑)>0, (阻力-C)/(C-支撑)>=3, 0);

{--- 信号输出 ---}
STICKLINE(日线金叉, 0, 1, 2, 0), COLORRED;
STICKLINE(日线死叉, 0, -1, 2, 0), COLORGREEN;
STICKLINE(放量突破, 0, 0.5, 2, 0), COLORYELLOW;
STICKLINE(地量, 0, -0.5, 2, 0), COLORBLUE;

DRAWTEXT(日线金叉, 1.2, '金叉'), COLORRED;
DRAWTEXT(放量突破 AND 值博率OK, 0.7, '放量+值博'), COLORYELLOW;
DRAWTEXT(地量, -0.7, '地量'), COLORBLUE;
DRAWTEXT(日线死叉, -1.2, '死叉'), COLORGREEN;
```

### 2.5 板块高低位标记（用于板块列表自定义列）

```tdx
{板块高低位 - 用于板块指数列表}

涨幅60日:=(C-REF(C,60))/REF(C,60)*100;

{简化判断: 60日涨幅>20%为高位, <-5%为低位}
状态:IF(涨幅60日>20, 1, IF(涨幅60日<-5, -1, 0)), NODRAW;

{1=高位(考虑兑现), -1=低位(考虑配置), 0=中性}
```

### 2.6 持仓盈亏监控（条件选股公式）

```tdx
{止损预警 - 用于条件预警}
{使用前需在参数中设置买入价}

买入价:=PARAM(1, 10);  {参数1: 买入价, 默认10}
止损比例:=PARAM(2, 10); {参数2: 止损百分比, 默认10}

亏损幅度:=(买入价-C)/买入价*100;
止损触发:=亏损幅度>=止损比例;

{技术止损: MACD死叉}
DIF:=EMA(C,12)-EMA(C,26);
DEA:=EMA(DIF,9);
MACD死叉:=CROSS(DEA,DIF);

{跌破20日低点}
破支撑:=C<LLV(L,20);

止损预警:止损触发 OR MACD死叉 OR 破支撑;
```

---

## 三、条件预警设置

通达信 → 功能 → 条件预警 → 设置

### 止损预警

| 预警名称 | 条件 | 适用范围 |
|---------|------|---------|
| 固定止损 | 现价 ≤ 买入价 × 0.9 | 所有持仓 |
| MACD死叉 | CROSS(DEA, DIF) | 所有持仓 |
| 破20日支撑 | C < LLV(L, 20) | 所有持仓 |
| 放量下跌 | V > MA(V,5)*2 AND C < O | 所有持仓 |

### 止盈预警

| 预警名称 | 条件 | 动作 |
|---------|------|------|
| 第一档止盈 | 现价 ≥ 买入价 × 1.2 | 考虑卖出1/3 |
| 第二档止盈 | 现价 ≥ 买入价 × 1.3 | 考虑再卖1/3 |
| 第三档止盈 | 现价 ≥ 买入价 × 1.5 | 考虑清仓 |
| 周线顶背离 | 价格新高但周DIF未新高 | 考虑减仓 |
| 高位缩量 | V < MA(V,5)*0.5 且近期高位 | 关注转弱 |

### 设置方法

1. 功能 → 预警系统 → 条件预警设置
2. 添加预警公式（使用上方公式或内置条件）
3. 选择监控股票范围 = 自选股
4. 设置预警间隔 = 1分钟（盘中）或收盘后触发

---

## 四、每日操作流程

### 盘后检查（约15分钟）

```
Step 1: 市场环境 (2分钟)
├─ 打开版面A区，切到上证周线
├─ 看周线MACD: 金叉/死叉？柱放大/缩小？
├─ 快速切换深证、创业板、科创50
└─ 结论: 当前市场阶段 → 仓位上限

Step 2: 资金面 (2分钟)
├─ 盘后数据 → 沪深港通 → 北向净买入
├─ 盘后数据 → 融资融券 → 融资余额变化
├─ 看510050/510300日线成交额变化
└─ 结论: 资金面偏多/偏空/中性

Step 3: 行业轮动 (3分钟)
├─ 版面B区: 板块按60日涨幅排序
├─ 标记高位板块(涨幅>20%) → 持仓中有无？
├─ 标记低位板块(涨幅<-5%) → 有无配置机会？
└─ 结论: 是否需要高切低

Step 4: 自选股扫描 (5分钟)
├─ 版面C区: 逐一查看自选股
├─ 看值博率列: ≥3 的标记
├─ 看周MACD列: 金叉(1/2) 的标记
├─ 点击个股 → D区看日线形态
├─ 有无金叉/放量突破/底背离？
└─ 结论: 哪些股票可以建仓

Step 5: 持仓检查 (3分钟)
├─ 查看条件预警记录
├─ 有无止损/止盈触发？
├─ 持仓个股所属板块是否转入高位？
└─ 结论: 是否需要止损/止盈/轮动
```

### 盘中关注（可选）

- 11:15 / 13:30 / 14:30 观察ETF资金流（无形之手时段）
- 条件预警弹窗提醒

---

## 五、通达信 vs TradePilot 边界

| 功能 | 通达信 | TradePilot |
|------|--------|-----------|
| 周线/月线MACD | ✅ 切周期即可 | 需日K聚合 |
| 板块涨幅排名 | ✅ 板块指数排序 | ✅ sector_rotation |
| 个股所属板块 | ✅ 右键→所属板块 | ❌ 缺申万映射 |
| 条件预警(止损/止盈) | ✅ 内置预警系统 | ⚠️ 需手动调API |
| 自定义指标公式 | ✅ 公式管理器 | ✅ analysis模块 |
| PB/PE数据 | ✅ F10/专业版 | ✅ valuation |
| 北向/融资数据 | ✅ 盘后数据 | ✅ fund_flow |
| K线形态 | ✅ 肉眼+公式 | ❌ 未实现 |
| **综合评分自动计算** | ❌ 公式能力有限 | ✅ signal.py |
| **每日自动扫描+建议** | ❌ 需手动逐一看 | Phase 2b 实现 |
| **建仓checklist判定** | ❌ 需人工对照 | Phase 2b 实现 |
| **分批止盈状态管理** | ❌ 无状态记录 | Phase 2c 实现 |
| **政策面标注** | ❌ 无此功能 | Phase 2a 实现 |
| **交易计划全流程** | ❌ 无此功能 | ✅ trade_plan |
| **历史建议记录** | ❌ 预警记录有限 | Phase 2b daily_report |

### 结论

通达信适合做**信息展示和人工判断**的初级版本，覆盖约60%的监控需求。TradePilot 的核心价值在于：

1. **自动化扫描** — 不用逐一手动查看每只自选股
2. **综合评分** — 多维度加权打分，量化决策
3. **状态管理** — 交易计划、分批止盈、持仓天数等需要持久化状态
4. **建议记录** — 每日建议存档，可回溯复盘

---

## 六、验证清单

用通达信版面运行1-2周后，回答以下问题：

- [ ] 四层监控清单是否完整？实际操作中缺少什么信息？
- [ ] 每日15分钟流程是否够用？哪一步最耗时？
- [ ] 值博率公式是否实用？阈值3是否合理？
- [ ] 板块高低位的60日/20%阈值是否合理？
- [ ] 条件预警是否及时？漏报/误报情况？
- [ ] 最痛苦的手动操作是什么？→ TradePilot 优先自动化
- [ ] 政策面判断靠什么信息源？如何标准化？
