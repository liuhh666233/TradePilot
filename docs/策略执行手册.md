# 策略执行手册

基于 `投资策略.md` 的理念，细化为可执行规则，标注系统实现差距。

---

## 一、系统实现差距分析

### 严重程度矩阵

| 策略维度 | 策略权重 | 实现度 | 差距 | 核心问题 |
|---------|---------|--------|------|---------|
| 政策面 | 30% | 待实现 | 高 | 采用手动标注+新闻补充方案，全局/自选股两级评分 |
| 资金面 | 25% | ~60% | 高 | 缺A50期指、主力资金流；情绪评分有bug |
| 技术面 | 20% | ~40% | 高 | 只有日线MACD，缺周线/月线/分钟线；无K线形态识别 |
| 估值面 | 15% | ~50% | 中 | 无跨行业PB对比、无前瞻PE |
| 行业轮动 | 10% | ~50% | 高 | 无个股→板块映射，高切低在个股层面断裂 |
| 风控/抽离 | 独立 | ~50% | 高 | 止盈未传入情绪/板块参数(死代码)；无分批止盈 |
| 盘面语言 | 定性 | 0% | 中 | 需盘中数据，暂不可实现 |
| 波浪定位 | 定性 | 0% | 低 | 本质主观，适合手动标注 |

### 已确认的 3 个关键 Bug

**Bug 1: 情绪评分双计北向、漏计融资**
- 文件: `tradepilot/analysis/fund_flow.py:94`
- 代码: `score += nb_result["trend_days"] * 2`
- 问题: 此处应为 `margin_result["trend_days"]`，当前用了北向资金的趋势天数，导致北向贡献被计算两次，融资余额趋势完全被忽略

**Bug 2: 周线MACD用日线模拟，方法论错误**
- 文件: `tradepilot/analysis/risk.py:27`
- 代码: `crosses = detect_cross(df.tail(10))` (注释写"周线死叉 用日线近5日模拟")
- 问题: 日线MACD取最后10根不等于周线MACD，周线MACD需要用周收盘价序列重新计算EMA12/26

**Bug 3: 止盈评估缺少关键参数**
- 文件: `tradepilot/api/trade_plan.py:189`
- 代码: `tp = evaluate_take_profit(plan["entry_actual_price"], current_price, plan["take_profit_pct"], kline)`
- 问题: `evaluate_take_profit()` 接受 `market_sentiment` 和 `sector_position` 参数，但调用方未传入，导致"市场情绪过热"和"板块高位预警"两个止盈条件永远不触发

---

## 二、量化执行规则

### 决策流程总览

```
市场环境定性 → 仓位上限
      ↓
行业选择(高切低) → 目标板块
      ↓
个股选择 → 候选标的
      ↓
建仓执行 → 价位/仓位/分批
      ↓
持仓监控 → 日常检查
      ↓
止损 / 止盈 / 高切低兑现
```

### 1. 市场环境定性 → 仓位上限 ❌未实现

根据月线+周线MACD状态组合判断市场阶段：

| 月线MACD | 周线MACD | 市场阶段 | 仓位上限 |
|---------|---------|---------|---------|
| 金叉+柱放大 | 金叉 | 牛市主升 | 80-100% |
| 金叉+柱缩小 | 死叉 | 牛市调整 | 50-70% |
| 死叉+柱缩小 | 金叉 | 震荡反弹 | 30-50% |
| 死叉+柱放大 | 死叉 | 熊市 | 0-20% |

辅助确认条件：
- 指数站上MA20且MA20拐头向上 → 短期趋势向上
- 指数站上MA60且MA60拐头向上 → 中期趋势向上
- 成交量 > 20日均量1.5倍 → 资金活跃

**待定问题**: 月线/周线K线需从日K聚合，聚合方法待确定（自然周 vs 交易周）

### 2. 行业选择 — 高切低量化规则 ⚠️部分实现

**当前实现** (`sector_rotation.py`): 60日涨幅排名 + PB截面排名，阈值 80%/30%

**需补充的规则**:

高位品种判定（兑现信号）:
- 60日涨幅排名 ≥ 前20% **且**
- PB历史分位 ≥ 80%（需历史窗口，建议3年）**且**
- 板块周线MACD出现死叉或顶背离

低位潜力品种判定（配置信号）:
- 60日涨幅排名 ≤ 后30% **且**
- PB历史分位 ≤ 30% **且**
- 存在政策催化或业绩拐点（手动标注）**且**
- 板块周线MACD未出现死叉

**关键缺失**: 个股→板块映射（需申万行业分类数据）

### 3. 个股选择 — 建仓 Checklist ⚠️部分实现

满足 **必要条件全部 + 加分条件≥2项** 方可建仓：

**必要条件（全部满足）**:
- [ ] 所属板块处于"低位潜力"区 ❌未实现（缺个股→板块映射）
- [ ] 值博率 ≥ 3（上涨空间/下跌风险）✅已实现 (`valuation.py`)
- [ ] 无重大利空（财务造假/退市风险/被ST）❌未实现

**加分条件（≥2项）**:
- [ ] 周线MACD金叉或即将金叉 ❌未实现（只有日线）
- [ ] PB处于历史30%分位以下 ✅已实现 (`valuation.py`)
- [ ] PE处于历史30%分位以下 ✅已实现 (`valuation.py`)
- [ ] 北向资金近5日净流入 ✅已实现 (`fund_flow.py`)
- [ ] 出现底背离信号 ✅已实现 (`technical.py`)
- [ ] 出现地量后首次放量 ⚠️部分实现（有地量检测，无"首次放量"逻辑）

### 4. 建仓执行 ❌未实现

**建仓价位**:
- 目标价 = 20日最低价附近（当前系统用 `kline["low"].tail(20).min()`）✅已实现
- 备选：布林带下轨、前期低点 ❌未实现

**分批建仓规则**（系统完全未实现）:
```
第1批(试仓): 目标仓位的 30%，条件=建仓checklist通过
第2批(加仓): 目标仓位的 40%，条件=买入后不破止损位 + 出现放量突破
第3批(满仓): 目标仓位的 30%，条件=周线MACD金叉确认 + 站上MA20
```

**单只个股仓位上限**: 总仓位的 20%（防集中风险）

### 5. 持仓监控 — 日常检查项 ❌未实现

每日收盘后检查：
- [ ] 日线MACD是否死叉 ✅可实现
- [ ] 是否跌破20日支撑位 ✅可实现
- [ ] 成交量是否异常（放量下跌/高位缩量）✅可实现
- [ ] 所属板块是否转入"高位" ❌缺板块映射
- [ ] 市场情绪是否过热 ⚠️有实现但有bug
- [ ] 持仓盈亏百分比 ✅可实现

### 6. 止损规则 ⚠️部分实现

三层止损，**任一触发即执行**：

| 止损类型 | 规则 | 实现状态 |
|---------|------|---------|
| 固定止损 | 从建仓均价计算，亏损≥10%清仓 | ✅已实现 |
| 技术止损 | 日线MACD死叉 + 跌破20日低点 + 放量下跌，三者出现任一 | ⚠️已实现但注释误称"周线" |
| 时间止损 | 持仓≥30个交易日且涨幅<5%，考虑换股 | ❌未实现 |

**待定问题**:
- 固定止损是从建仓均价算还是从最高价回撤（trailing stop）？当前从建仓价算
- 技术止损触发后是全部清仓还是减仓50%？当前设计只有提醒

### 7. 止盈规则 ⚠️部分实现（有关键bug）

**分批止盈**（系统未实现分批逻辑）:
```
第1批(1/3仓位): 盈利 ≥ 20% 或 出现周线顶背离
第2批(1/3仓位): 盈利 ≥ 30% 或 高位缩量 或 市场情绪过热(≥80)
第3批(清仓):    盈利 ≥ 50% 或 周线MACD死叉 或 板块转入高位
```

**移动止盈**（系统未实现）:
- 盈利达到20%后，设置回撤10%的移动止盈线
- 即：最高盈利 - 10% = 止盈触发线

**"抽离"纪律量化标准**:
- 市场情绪评分 ≥ 80 → "过热，减仓至50%以下" ✅已实现（但有bug未传入参数）
- 所属板块60日涨幅排名前10% → "板块过热，兑现" ❌未实现
- 两融余额连续5日增长且增速>日均1% → "杠杆过热" ❌未实现

### 8. 高切低执行流程 ⚠️部分实现

完整流程：
```
Step 1: 兑现信号触发（板块高位 + 个股止盈条件满足）
         → 执行止盈，回收现金
Step 2: 筛选目标板块（低位潜力板块列表）
         → sector_rotation.py 的 low_opportunities ✅已实现
Step 3: 板块内选股（建仓checklist）
         → 需要板块→个股的反向映射 ❌未实现
Step 4: 建仓执行（分批建仓规则）
         → ❌未实现
```

**核心断裂点**: 系统能识别"哪些板块高位/低位"，但不知道"个股属于哪个板块"，导致：
- 无法判断持仓个股是否在高位板块（`trade_plan.py:63` 的 sector_position 逻辑错误）
- 无法从低位板块中筛选具体个股

---

## 三、每日监控清单

### 交易模式总览

```
自选股管理 → 每日盘后扫描 → 建仓建议 → 持仓监控 → 止损/补仓/止盈建议
     ↑                                                    ↓
     └──────────── 高切低轮动（兑现→选板块→选股→建仓）←──────┘
```

用户事先加入符合预期的自选股，系统每日收盘后自动扫描，对自选股发出建仓建议，对持仓股发出止损/补仓/止盈建议。

### 第一层：市场环境（决定仓位上限）

| 监控项 | 数据源 | 决策作用 | 实现状态 |
|--------|--------|----------|----------|
| 指数周线MACD状态 | 周K线(日K聚合) | 牛市主升→满仓；调整→半仓；熊市→空仓 | ❌ 缺周线聚合 |
| 市场情绪评分(0-100) | ETF流入+北向+融资 | ≥80过热减仓，≤30恐慌可抄底 | ✅ `fund_flow.py` |
| 北向资金净流入(5日) | 北向数据 | 持续流入=外资看多 | ✅ `fund_flow.py` |
| 融资余额趋势 | 两融数据 | 连涨5日+日增>1%=杠杆过热 | ✅ `fund_flow.py` |
| ETF大额净流入 | 510050/510300等 | 国家队托底信号 | ✅ `fund_flow.py` |
| 政策面评分 | 手动标注 | 重大利好/利空直接影响仓位 | ❌ 待实现 |

### 第二层：行业轮动（决定买什么板块）

| 监控项 | 数据源 | 决策作用 | 实现状态 |
|--------|--------|----------|----------|
| 板块60日涨幅排名 | 行业数据 | 识别高位板块（待兑现） | ✅ `sector_rotation.py` |
| 板块PB分位数 | 行业估值 | 低PB=安全边际 | ✅ `sector_rotation.py` |
| 高切低建议 | 轮动分析 | 高位板块→低位板块 | ✅ `sector_rotation.py` |
| 个股↔板块映射 | 申万分类 | 知道自选股属于哪个板块 | ❌ 未实现 |

### 第三层：自选股扫描（决定买哪只）

| 监控项 | 数据源 | 决策作用 | 实现状态 |
|--------|--------|----------|----------|
| 综合评分(0-100) | 技术+估值+资金+轮动+政策 | >70建仓信号，<40回避 | ⚠️ 缺政策面权重 |
| 日线MACD金叉/死叉 | 日K线 | 短期趋势转折 | ✅ `technical.py` |
| 周线MACD金叉 | 周K线 | 中期建仓核心信号 | ❌ 缺周线 |
| 底背离/顶背离 | K线+MACD | 反转信号 | ✅ `technical.py` |
| 放量突破/高位缩量 | 成交量 | 突破有效性确认 | ✅ `technical.py` |
| PE/PB分位数 | 估值数据 | <30%低估，>70%高估 | ✅ `valuation.py` |
| 值博率 | 支撑位/阻力位 | ≥3值得博弈 | ✅ `valuation.py` |
| 自选股政策标注 | 手动标注 | 利好/利空/中性 | ❌ 待实现 |

### 第四层：持仓监控（决定走不走）

| 监控项 | 数据源 | 决策作用 | 实现状态 |
|--------|--------|----------|----------|
| 浮动盈亏% | 现价vs买入价 | 触发止损(-10%)/止盈(+20/30/50%) | ✅ `risk.py` |
| 技术止损信号 | MACD死叉+破MA20+放量下跌 | 任一触发→考虑止损 | ✅ `risk.py` |
| 持仓天数 | 买入日期 | >30天且盈利<5%→考虑轮动 | ❌ 未实现 |
| 市场情绪过热 | 情绪评分≥80 | 触发抽离纪律 | ✅ `risk.py`(已修复) |
| 板块高位预警 | 板块轮动 | 所在板块过热→兑现 | ⚠️ 缺个股→板块映射 |
| 分批止盈 | 盈利阶段 | 1/3@20%, 1/3@30%, 清仓@50% | ❌ 未实现 |

### 每日扫描引擎输出格式

扫描引擎每天对每只自选股/持仓股生成一条建议：

```json
{
  "stock_code": "600519",
  "stock_name": "贵州茅台",
  "action": "建仓|加仓|持有|减仓|清仓|观望",
  "urgency": "立即|关注|无需操作",
  "score": 72,
  "reasons": [
    "✅ 周线MACD金叉",
    "✅ PB分位 22% (低估)",
    "✅ 北向资金连续流入",
    "⚠️ 板块60日涨幅偏高"
  ],
  "risk_alerts": [
    "融资余额连涨4日，接近过热"
  ],
  "suggested_price": 1680.00,
  "suggested_stop_loss": 1512.00,
  "suggested_take_profit": [1848.00, 2016.00, 2184.00]
}
```

### 政策面手动标注方案

政策面占策略权重30%，难以完全自动化，采用手动标注+系统辅助方案：

**全局政策评分**（影响仓位上限）:
- 评分范围: 0-100（50=中性，>70=利好，<30=利空）
- 用户每日/每周手动更新
- 参考维度: 货币政策、财政政策、监管政策、产业政策
- 纳入综合评分: `总分 = 30%×政策 + 25%×资金 + 20%×技术 + 15%×估值 + 10%×轮动`

**自选股级别政策标注**（影响个股建仓决策）:
- 标注类型: 利好/利空/中性
- 备注字段: 记录具体政策事件
- 影响: 利好+5分，利空-10分（叠加到综合评分）

**数据结构**:
- `watchlist` 表新增: `policy_tag` (利好/利空/中性), `policy_note` (TEXT)
- 新增全局配置: `global_policy_score` (0-100), `policy_updated_at` (DATE)

---

## 四、知识补充路线图

### P0 — 直接影响策略执行

| 知识领域 | 为什么需要 | 学习方向 | 关联模块 |
|---------|-----------|---------|---------|
| 周线/月线K线聚合 | 策略核心信号基于周线MACD，当前只有日线 | 日K→周K/月K聚合标准方法；不完整周期处理；pandas resample('W-Fri') | `technical.py` |
| 申万行业分类 | 高切低需要个股→板块映射 | 申万一级/二级/三级分类体系；AKShare `ak.stock_board_industry_name_em()` | `sector_rotation.py`, `trade_plan.py` |
| K线形态识别 | 策略提及吊顶线等见顶形态 | 经典形态的数学定义（锤子线/吊颈线/吞没/十字星）；talib库或手写 | `technical.py` |
| 支撑位/阻力位计算 | 建仓价位和止损依赖支撑位 | 前高前低法、均线支撑(MA20/MA60)、布林带、斐波那契回撤 | `valuation.py`, `risk.py` |

### P1 — 提升策略精度

| 知识领域 | 为什么需要 | 学习方向 | 关联模块 |
|---------|-----------|---------|---------|
| 波浪理论基础 | 策略用波浪定位市场阶段 | Elliott Wave基本规则；浪型标注方法；系统中做手动标注UI | 前端Dashboard |
| 仓位管理模型 | 策略提"基于值博率定仓位"但无公式 | Kelly公式；固定比例法；ATR仓位法；值博率→仓位映射 | 新模块 |
| 市场情绪量化 | "抽离"纪律需要量化"过热" | 恐贪指数构建；涨停/跌停家数；换手率极值分布 | `fund_flow.py` |
| 主力资金流分析 | 策略强调"观察主力真实意图" | Level-2数据结构；超大单/大单/中单/小单划分标准 | `fund_flow.py` |
| A50期指联动 | 策略视为先行指标 | 新加坡A50期指数据源；升贴水含义；与沪深300领先滞后关系 | `fund_flow.py` |

### P2 — 长期完善

| 知识领域 | 为什么需要 | 学习方向 |
|---------|-----------|---------|
| 可转债定价 | 策略提"转债验证正股安全性" | 转股溢价率、债底保护、强赎条款 |
| 行业周期理论 | 策略展示深厚的周期轮动经验 | 美林时钟、库存周期、猪周期等行业特有周期 |
| 盘面微观结构 | 策略提"对倒砸盘""抵抗式下跌" | 订单簿分析、大单拆分检测、盘中异动模式 |
| 政策NLP分析 | 政策面权重30%但完全靠手动 | 中文政策文本情感分析、关键词提取、事件驱动策略 |
| 回测框架 | 所有规则需历史验证 | backtrader/vnpy/自建回测；Mock数据→真实数据回测对比 |

---

## 五、下一步行动建议

### 已修复（Bug Fix）
1. ~~`fund_flow.py:94` 融资趋势变量名错误~~ ✅
2. ~~`trade_plan.py:189` 补传 market_sentiment 和 sector_position~~ ✅
3. ~~`risk.py:27` 移除错误的"周线"注释，明确标注为日线MACD~~ ✅

### Phase 2a: 自选股 + 基础设施
1. `watchlist` 表 + CRUD API + 前端页面（含政策标注字段）
2. 日K→周K/月K聚合函数 + 周线MACD计算
3. 申万行业分类数据 → 个股↔板块映射
4. 政策面手动标注（全局评分 + 自选股级别标注）

### Phase 2b: 每日扫描引擎（核心价值）
1. `scan_watchlist()` — 遍历自选股，生成建仓建议
2. `scan_positions()` — 遍历持仓，生成止损/补仓/止盈建议
3. `daily_report` 表 + API 存储扫描结果
4. Dashboard 新增"今日建议"卡片

### Phase 2c: 精细化
1. 分批建仓/止盈逻辑 → trade_plan 状态机扩展
2. 时间止损 → 持仓天数监控
3. 定时任务（盘后自动扫描）
4. 接入真实数据 (AKShare)

### 策略参数待确认
以下参数需要策略制定者确认后写入系统配置：

| 参数 | 当前默认值 | 待确认 |
|------|-----------|--------|
| 固定止损比例 | -10% | 是否需要按波动率调整？ |
| 固定止盈比例 | 30% | 分批止盈的各档比例？ |
| 单股仓位上限 | 无限制 | 建议20%，是否合理？ |
| PB历史分位窗口 | 250日(1年) | 策略是否需要3年或5年？ |
| 情绪过热阈值 | 80 | 是否需要调整？ |
| 高位板块动量阈值 | 前20% | 是否需要调整？ |
| 低位板块动量阈值 | 后30% | 是否需要调整？ |
| 值博率建仓门槛 | 3 | 不同市场阶段是否不同？ |
