# TradePilot 系统设计文档

## 一、系统架构总览

### 技术选型
- 后端: Python + FastAPI + DuckDB
- 前端: React + TypeScript + Vite + Yarn
- 数据源: 先 Mock，后续接 AKShare 等真实数据
- 定位: 辅助决策看板

### 系统架构图

```
┌─────────────────────────────────────────────────────┐
│                    Frontend (React)                   │
│  Dashboard │ Analysis │ Portfolio │ Signals │ Sector  │
└──────────────────────┬──────────────────────────────┘
                       │ REST API (JSON)
┌──────────────────────┴──────────────────────────────┐
│                  Backend (FastAPI)                    │
│                                                      │
│  ┌─────────┐  ┌───────────┐  ┌──────────────────┐  │
│  │ API层    │  │ 调度层     │  │ 数据层            │  │
│  │ /market  │  │ scheduler │  │ data_provider    │  │
│  │ /signal  │  │ (定时拉取) │  │ (Mock/AKShare)   │  │
│  │ /portfolio│ └───────────┘  └────────┬─────────┘  │
│  │ /analysis│                          │             │
│  └────┬─────┘                          │             │
│       │         ┌──────────────────────┘             │
│  ┌────┴─────────┴──────────────────────────────┐    │
│  │              分析引擎层                        │    │
│  │  technical │ valuation │ fund_flow │ signal  │    │
│  │  sector_rotation │ risk                      │    │
│  └──────────────────────┬──────────────────────┘    │
│                          │                           │
│  ┌───────────────────────┴─────────────────────┐    │
│  │              DuckDB (存储层)                   │    │
│  │  行情表 │ 资金流表 │ 持仓表 │ 信号表 │ 估值表  │    │
│  └─────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘
```

### 后端模块划分

```
tradepilot/
├── main.py                  # FastAPI 入口 + uvicorn 启动
├── config.py                # 配置 (DB路径/数据源切换/参数)
├── db.py                    # DuckDB 连接管理 + 表初始化
│
├── data/                    # 数据采集层 (可切换 Mock/真实)
│   ├── provider.py          # 数据源抽象接口
│   ├── mock_provider.py     # Mock 数据实现
│   └── akshare_provider.py  # AKShare 真实数据 (后续)
│
├── analysis/                # 分析引擎层
│   ├── technical.py         # 技术指标计算
│   ├── valuation.py         # 估值分析
│   ├── fund_flow.py         # 资金面分析
│   ├── sector_rotation.py   # 行业轮动 + 高切低
│   ├── signal.py            # 综合信号生成
│   └── risk.py              # 风控 + 抽离提醒
│
├── portfolio/               # 组合管理
│   └── manager.py           # 持仓管理
│
├── api/                     # API 路由
│   ├── market.py            # 行情接口
│   ├── analysis.py          # 分析接口
│   ├── portfolio.py         # 持仓接口
│   └── signal.py            # 信号接口
│
└── scheduler/               # 定时任务
    └── jobs.py              # 数据更新调度
```

### 前端页面划分

```
webapp/src/
├── pages/
│   ├── Dashboard/           # 仪表盘: 大盘概览 + 波浪定位 + 资金面
│   ├── StockAnalysis/       # 个股分析: 技术面 + 估值 + 盘面语言
│   ├── SectorMap/           # 行业地图: 板块热度 + 轮动 + 高切低
│   ├── Portfolio/           # 持仓管理: 当前持仓 + 盈亏 + 抽离提醒
│   └── Signals/             # 信号中心: 买卖信号列表 + 筛选
├── components/              # 通用组件 (K线图/指标图/表格)
├── services/                # API 调用封装
└── stores/                  # 状态管理
```

---

## 二、策略需求拆解

基于投资策略文档，提炼出系统需要实现的 6 大分析维度：

### 1. 政策面分析 (优先级最高，暂为手动输入)
- 用户手动录入政策事件和判断
- 系统记录并展示政策时间线
- 后续可接入新闻 API 做辅助

### 2. 资金面分析
- ETF 资金流向监控 (510050/510300/510500/512100)
- 两融数据 (融资余额变化趋势)
- 北向资金 (每日净流入/流出)
- 成交量分析 (放量/缩量/地量判断)
- A50 期指方向 (作为先行指标)

### 3. 技术面分析
- MACD (日线/周线/月线/季线)
  - 金叉/死叉信号
  - 顶背离/底背离
- K 线形态识别 (吊顶线等高位见顶形态)
- 成交量配合 (放量突破/缩量调整)
- 60 分钟/30 分钟短线背离

### 4. 估值面分析
- 市净率 (PB) — 行业横向对比
- 动态市盈率 (PE) — 结合业绩预期
- 值博率计算 — 潜在上涨空间 / 下跌风险

### 5. 行业轮动 + 高切低
- 板块涨幅排名 (区间涨幅: 5日/20日/60日)
- 板块估值对比 (PB/PE 横向)
- 高位品种标记 (涨幅过大 + 估值过高)
- 低位潜力品种标记 (低估 + 基本面改善)
- "高切低"建议生成

### 6. 风控 + "抽离"纪律
- 持仓盈利达标提醒 (可配置阈值，如 30%)
- 市场一致性看多预警 (情绪过热信号)
- 止盈/止损触发提醒

---

## 三、数据需求清单

### A. 行情数据

| 数据项 | 粒度 | 字段 | 用途 |
|--------|------|------|------|
| 个股日K线 | 日 | date, open, high, low, close, volume, amount, turnover | 技术分析基础 |
| 个股周K线 | 周 | 同上 | 周线 MACD / 背离 |
| 个股月K线 | 月 | 同上 | 月线形态 / 季线金叉 |
| 指数日K线 | 日 | 同上 (上证/深证/创业板/科创50) | 大盘判断 |
| 分钟K线 | 30min/60min | 同上 | 短线背离判断 |

### B. 资金面数据

| 数据项 | 粒度 | 字段 | 用途 |
|--------|------|------|------|
| ETF 净申赎/资金流 | 日 | date, etf_code, net_inflow, volume | 无形之手判断 |
| 融资融券余额 | 日 | date, stock_code, margin_balance, margin_buy | 市场情绪 |
| 北向资金 | 日 | date, net_buy, buy_amount, sell_amount | 外资动向 |
| 个股主力资金流 | 日 | date, stock_code, super_large_net, large_net | 主力行为 |
| A50 期指 | 日 | date, close, change_pct | 先行指标 |

### C. 估值数据

| 数据项 | 粒度 | 字段 | 用途 |
|--------|------|------|------|
| 个股估值 | 日 | date, stock_code, pe_ttm, pb, ps, market_cap | 估值分析 |
| 行业估值 | 日 | date, sector, avg_pe, avg_pb, median_pe, median_pb | 行业对比 |
| 行业涨跌幅 | 日 | date, sector, change_1d, change_5d, change_20d, change_60d | 轮动判断 |

### D. 持仓数据 (用户录入)

| 数据项 | 字段 |
|--------|------|
| 持仓记录 | stock_code, stock_name, buy_date, buy_price, quantity, current_price, pnl_pct |
| 交易记录 | date, stock_code, direction(buy/sell), price, quantity, reason |

---

## 四、信号计算逻辑

### Signal 1: MACD 金叉/死叉

```
输入: K线数据 (日/周/月)
计算:
  EMA12 = EMA(close, 12)
  EMA26 = EMA(close, 26)
  DIF = EMA12 - EMA26
  DEA = EMA(DIF, 9)
  MACD柱 = (DIF - DEA) * 2

信号:
  - 周线金叉 (DIF上穿DEA): 中期买入信号 ★★★
  - 周线死叉 (DIF下穿DEA): 中期卖出信号 ★★★
  - 日线金叉: 短期买入参考 ★★
  - 季线金叉: 超长期趋势信号 ★★★★★
```

### Signal 2: MACD 背离

```
输入: K线数据 + MACD
计算:
  底背离: 价格创新低，但 DIF/MACD柱 未创新低
  顶背离: 价格创新高，但 DIF/MACD柱 未创新高

信号:
  - 周线底背离: 阶段性底部 ★★★★
  - 周线顶背离: 阶段性顶部 ★★★★
  - 60分钟背离: 短线反转参考 ★★
```

### Signal 3: 成交量异动

```
输入: K线数据
计算:
  vol_ma5 = MA(volume, 5)
  vol_ma20 = MA(volume, 20)
  vol_ratio = volume / vol_ma5

信号:
  - 放量突破 (vol_ratio > 2 且 close > 前高): 买入信号 ★★★
  - 高位缩量 (vol_ratio < 0.5 且 处于高位): 转弱信号 ★★
  - 地量 (volume 创 N 日新低): 可能见底 ★★
```

### Signal 4: 值博率 (风险收益比)

```
输入: 当前价格, 估值数据, 历史价格区间
计算:
  support = 近期支撑位 (前低/均线)
  resistance = 目标位 (前高/估值合理位)
  downside_risk = (current - support) / current
  upside_potential = (resistance - current) / current
  risk_reward_ratio = upside_potential / downside_risk

信号:
  - 值博率 > 3: 高值博率，值得关注 ★★★★
  - 值博率 1~3: 一般
  - 值博率 < 1: 风险大于收益，回避
```

### Signal 5: 高切低 (行业轮动)

```
输入: 行业涨跌幅数据, 行业估值数据
计算:
  对每个行业:
    momentum_score = 区间涨幅排名 (60日)
    valuation_score = PB/PE 分位数 (历史百分位)

  高位品种: momentum_score 前20% 且 valuation_score > 80%分位
  低位潜力: momentum_score 后30% 且 valuation_score < 30%分位 且基本面无恶化

信号:
  - 高位预警: "XX板块涨幅过大+估值偏高，注意兑现" ★★★
  - 低位机会: "XX板块低估+滞涨，值博率高" ★★★
  - 高切低建议: "从XX板块兑现 → 配置YY板块" ★★★★
```

### Signal 6: ETF 资金流向 (无形之手)

```
输入: ETF 日度资金流数据 (510050/510300/510500/512100)
计算:
  net_inflow_sum = 近 N 日 ETF 合计净流入
  inflow_trend = 连续流入/流出天数

信号:
  - 大幅净流入 (单日 > 阈值): 无形之手托底 ★★★
  - 持续净流出: 注意风险 ★★
  - 权重ETF与中小盘ETF分化: 跷跷板效应 ★★
```

### Signal 7: 融资余额变化

```
输入: 两融数据
计算:
  margin_change = 融资余额日变化
  margin_ma5 = MA(margin_balance, 5)
  margin_trend = 连续增减天数

信号:
  - 融资余额持续攀升: 市场情绪乐观 (但需警惕过热)
  - 融资余额快速下降: 恐慌信号
```

### Signal 8: 抽离提醒 (风控)

```
输入: 持仓数据 + 市场情绪指标
计算:
  pnl_pct = (current_price - buy_price) / buy_price
  holding_days = today - buy_date
  market_sentiment = 综合情绪评分 (融资/成交量/涨停数)

信号:
  - 单股盈利 > 30%: "建议部分兑现" ★★★★
  - 市场情绪过热 (sentiment > 阈值): "市场一致看多，注意抽离" ★★★★★
  - 持仓时间过长且横盘: "考虑换股" ★★
```

---

## 五、综合信号评分框架

```
每只股票/每个板块的综合评分:

总分 = Σ (信号权重 × 信号得分)

权重分配:
  政策面信号: 30% (手动标注)
  资金面信号: 25% (ETF + 两融 + 北向 + 主力)
  技术面信号: 20% (MACD + 背离 + 量价)
  估值面信号: 15% (PB/PE分位 + 值博率)
  行业轮动信号: 10% (高切低位置)

输出:
  - 强烈看多 (>80分)
  - 看多 (60~80)
  - 中性 (40~60)
  - 看空 (20~40)
  - 强烈看空 (<20)
```

---

## 六、DuckDB 表结构设计

```sql
-- 个股日K线
CREATE TABLE stock_daily (
  stock_code VARCHAR, date DATE,
  open DOUBLE, high DOUBLE, low DOUBLE, close DOUBLE,
  volume BIGINT, amount DOUBLE, turnover DOUBLE,
  PRIMARY KEY (stock_code, date)
);

-- 指数日K线
CREATE TABLE index_daily (
  index_code VARCHAR, date DATE,
  open DOUBLE, high DOUBLE, low DOUBLE, close DOUBLE,
  volume BIGINT, amount DOUBLE,
  PRIMARY KEY (index_code, date)
);

-- ETF 资金流
CREATE TABLE etf_flow (
  etf_code VARCHAR, date DATE,
  net_inflow DOUBLE, volume BIGINT,
  PRIMARY KEY (etf_code, date)
);

-- 融资融券
CREATE TABLE margin_data (
  date DATE, stock_code VARCHAR,
  margin_balance DOUBLE, margin_buy DOUBLE,
  PRIMARY KEY (date, stock_code)
);

-- 北向资金
CREATE TABLE northbound_flow (
  date DATE,
  net_buy DOUBLE, buy_amount DOUBLE, sell_amount DOUBLE,
  PRIMARY KEY (date)
);

-- 个股估值
CREATE TABLE stock_valuation (
  stock_code VARCHAR, date DATE,
  pe_ttm DOUBLE, pb DOUBLE, ps DOUBLE, market_cap DOUBLE,
  PRIMARY KEY (stock_code, date)
);

-- 行业数据
CREATE TABLE sector_data (
  sector VARCHAR, date DATE,
  avg_pe DOUBLE, avg_pb DOUBLE,
  change_1d DOUBLE, change_5d DOUBLE, change_20d DOUBLE, change_60d DOUBLE,
  PRIMARY KEY (sector, date)
);

-- 持仓
CREATE TABLE portfolio (
  id INTEGER PRIMARY KEY,
  stock_code VARCHAR, stock_name VARCHAR,
  buy_date DATE, buy_price DOUBLE, quantity INTEGER,
  status VARCHAR DEFAULT 'open'
);

-- 交易记录
CREATE TABLE trades (
  id INTEGER PRIMARY KEY,
  date DATE, stock_code VARCHAR, stock_name VARCHAR,
  direction VARCHAR, price DOUBLE, quantity INTEGER,
  reason VARCHAR
);

-- 信号记录
CREATE TABLE signals (
  id INTEGER PRIMARY KEY,
  date DATE, stock_code VARCHAR,
  signal_type VARCHAR, signal_name VARCHAR,
  direction VARCHAR, strength INTEGER,
  description VARCHAR
);
```

---

## 七、实施计划 (分阶段)

### Phase 1: 基础骨架
- 搭建 FastAPI 项目结构 + DuckDB 初始化
- Mock 数据 provider (生成模拟行情/资金面数据)
- 基础 API (行情查询/持仓 CRUD)
- 前端路由 + Dashboard 页面骨架

### Phase 2: 技术分析引擎
- MACD 计算 (日/周/月线)
- 金叉/死叉/背离信号检测
- 成交量异动信号
- 前端: K线图 + 技术指标展示

### Phase 3: 估值 + 行业轮动
- 估值分析 (PB/PE 分位数)
- 值博率计算
- 行业涨幅排名 + 高切低逻辑
- 前端: 行业地图 + 高切低建议

### Phase 4: 资金面 + 综合信号
- ETF 资金流/两融/北向资金分析
- 综合信号评分系统
- 抽离提醒 (风控)
- 前端: 信号中心 + 持仓管理

### Phase 5: 接入真实数据
- 替换 Mock 为 AKShare
- 定时任务调度 (每日收盘后更新)
